const fs = require('fs');
const path = require('path');
const tar = require('tar');

const cache = new Map();

function ReqArt(artPath) {
  if (cache.has(artPath)) {
    return cache.get(artPath);
  }

  if (!fs.existsSync(artPath)) {
    throw new Error(`Arquivo ${artPath} n√£o encontrado`);
  }

  const tempDir = path.join('./art-packages', '.reqart-temp', path.basename(artPath, '.art'));
  
  if (fs.existsSync(tempDir)) fs.rmSync(tempDir, { recursive: true, force: true });
  fs.mkdirSync(tempDir, { recursive: true });

  tar.x({ file: artPath, cwd: tempDir, sync: true });

  const packageDir = path.join(tempDir, 'package');
  const packageJsonPath = path.join(packageDir, 'package.json');
  const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
  const mainFile = path.resolve(packageDir, packageJson.main || 'index.js');

  const mod = require(mainFile);
  
  cache.set(artPath, mod);
  
  fs.rmSync(tempDir, { recursive: true, force: true });
  
  return mod;
}
module.exports = ReqArt;
